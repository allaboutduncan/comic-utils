{% extends 'base.html' %}
{% block title %}Browse Library{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/collection.css') }}?v={{ range(1, 10000) | random }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<script>
    // Initial path from URL (e.g., /collection/Marvel -> /data/Marvel)
    window.INITIAL_PATH = {{ initial_path | default ('') | tojson | safe }};
</script>
{% endblock %}
{% block content %}
<div class="container-lg mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <nav aria-label="breadcrumb" class="flex-grow-1">
            <ol class="breadcrumb mb-0" id="breadcrumb">
                <li class="breadcrumb-item active">Loading...</li>
            </ol>
        </nav>
        <!-- Main View Toggle Buttons -->
        <div class="mx-3">
            <div class="btn-group btn-group-sm" role="group" aria-label="View selection">
                <button class="btn btn-primary" id="directoryViewBtn" onclick="loadDirectoryView()">
                    <i class="bi bi-folder"></i> Directory View
                </button>
                <button class="btn btn-outline-primary" id="recentlyAddedBtn" onclick="loadRecentlyAdded()">
                    <i class="bi bi-clock-history"></i> Recently Added
                </button>
            </div>
        </div>
        <!-- View Toggle Buttons -->
        <div class="mx-3" id="viewToggleButtons">
            <button class="btn btn-outline-primary btn-sm" id="allBooksBtn" onclick="loadAllBooks()"
                style="display: none;">
                <i class="bi bi-collection"></i> All Books
            </button>
            <button class="btn btn-primary btn-sm" id="folderViewBtn" onclick="returnToFolderView()"
                style="display: none;">
                <i class="bi bi-folder"></i> Folder View
            </button>
        </div>
        <div class="d-flex align-items-center">
            <div class="input-group input-group-sm me-2">
                <label class="input-group-text" for="itemsPerPage">Per page</label>
                <select class="form-select" id="itemsPerPage" onchange="changeItemsPerPage(this.value)">
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="250">250</option>
                </select>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshCurrentView(true, true)" title="Refresh">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <!-- Filter Bar -->
    <div class="d-flex flex-wrap flex-md-nowrap gap-2 gap-md-3 mb-3">
        <div id="gridFilterButtons" style="display: none; flex: 1 1 auto;">
            <div class="btn-group btn-group-sm" role="group" aria-label="Filter by first letter">
                <!-- Filter buttons will be dynamically populated by JS -->
            </div>
        </div>
        <div id="gridSearchRow" style="flex: 0 0 auto; width: 100%; max-width: 250px;">
            <!-- Search input will be dynamically populated by JS -->
        </div>
    </div>

    <!-- Dashboard Sections -->
    <div id="dashboard-sections" class="mb-5" style="display: none;">
        <!-- Favorite Collections -->
        <section class="mb-4 dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h4 class="m-0"><i class="bi bi-bookmark-heart-fill text-danger me-2"></i>Favorite Collections</h4>
                <button class="btn btn-sm btn-link text-decoration-none">View All</button>
            </div>
            <div class="swiper dashboard-swiper" id="favoritesSwiper">
                <div class="swiper-wrapper">
                    <!-- Loaded dynamically by loadFavoritePublishers() -->
                    <div class="swiper-slide">
                        <div class="dashboard-card text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </section>

        <!-- Want to Read -->
        <!--
        <section class="mb-4 dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h4 class="m-0"><i class="bi bi-bookmark-star-fill text-warning me-2"></i>Want to Read</h4>
                <button class="btn btn-sm btn-link text-decoration-none">View All</button>
            </div>
            <div class="swiper dashboard-swiper" id="wantToReadSwiper">
                <div class="swiper-wrapper">

                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/333/fff?text=Saga" alt="Saga">
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">Saga Vol. 1</h6>
                                <small class="text-muted">Brian K. Vaughan</small>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/333/fff?text=Watchmen" alt="Watchmen">
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">Watchmen</h6>
                                <small class="text-muted">Alan Moore</small>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/333/fff?text=Sandman" alt="Sandman">
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">The Sandman Vol. 1</h6>
                                <small class="text-muted">Neil Gaiman</small>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/333/fff?text=Maus" alt="Maus">
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">Maus</h6>
                                <small class="text-muted">Art Spiegelman</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </section>
        -->
        <!-- Recently Added -->
        <!--
        <section class="mb-4 dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h4 class="m-0"><i class="bi bi-clock-history text-primary me-2"></i>Recently Added</h4>
                <button class="btn btn-sm btn-link text-decoration-none">View All</button>
            </div>
            <div class="swiper dashboard-swiper" id="recentAddedSwiper">
                <div class="swiper-wrapper">

                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/444/fff?text=X-Men+97" alt="X-Men">
                                <div class="dashboard-card-badge bg-success">New</div>
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">X-Men '97 #1</h6>
                                <small class="text-muted">Added Today</small>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/444/fff?text=Batman+145" alt="Batman">
                                <div class="dashboard-card-badge bg-success">New</div>
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">Batman #145</h6>
                                <small class="text-muted">Added Yesterday</small>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/444/fff?text=ASM+45" alt="ASM">
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">Amazing Spider-Man #45</h6>
                                <small class="text-muted">Added 2 days ago</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </section>
        -->
        <!-- Recently Read -->
        <!--
        <section class="mb-4 dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h4 class="m-0"><i class="bi bi-book-half text-info me-2"></i>Recently Read</h4>
                <button class="btn btn-sm btn-link text-decoration-none">View All</button>
            </div>
            <div class="swiper dashboard-swiper" id="recentReadSwiper">
                <div class="swiper-wrapper">

                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/555/fff?text=Invincible" alt="Invincible">
                                <div class="progress"
                                    style="height: 4px; position: absolute; bottom: 0; left: 0; width: 100%;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 75%"
                                        aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">Invincible #12</h6>
                                <small class="text-muted">75% Complete</small>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="dashboard-card">
                            <div class="dashboard-card-img-container">
                                <img src="https://placehold.co/300x450/555/fff?text=Walking+Dead" alt="Walking Dead">
                                <div class="progress"
                                    style="height: 4px; position: absolute; bottom: 0; left: 0; width: 100%;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 30%"
                                        aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="dashboard-card-body">
                                <h6 class="text-truncate">The Walking Dead #45</h6>
                                <small class="text-muted">30% Complete</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </section>
        -->
    </div>
    <div id="loading-indicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div id="file-grid" class="file-grid" style="display: none;">
        <!-- Grid items will be populated by JS -->
    </div>
    <div id="empty-state" class="text-center py-5" style="display: none;">
        <i class="bi bi-folder2-open display-1 text-muted"></i>
        <p class="lead text-muted mt-3">This folder is empty</p>
    </div>
    <nav id="pagination-controls" aria-label="File browser pagination" class="mt-4" style="display: none;">
        <ul class="pagination justify-content-center" id="pagination-list">
            <!-- Pagination items will be populated by JS -->
        </ul>
    </nav>
</div>
<!-- Template for Grid Item -->
<template id="grid-item-template">
    <div class="grid-item">
        <div class="thumbnail-container">
            <img src="" alt="" class="thumbnail" loading="lazy">
            <div class="icon-overlay">
                <i class="bi"></i>
            </div>
            <button class="info-button no-propagation" title="CBZ Information">
                <i class="bi bi-info-circle"></i>
            </button>
            <button class="favorite-button no-propagation" title="Add to Favorites" style="display: none;">
                <i class="bi bi-bookmark-heart"></i>
            </button>
        </div>
        <div class="item-info d-flex justify-content-between align-items-start mt-2">
            <div class="item-details text-truncate flex-grow-1">
                <div class="item-name text-truncate" title=""></div>
                <div class="item-meta text-muted small"></div>
            </div>
            <div class="item-actions dropdown ms-2">
                <button class="btn btn-link btn-sm p-0 text-secondary no-propagation" type="button"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item action-crop" href="#">Crop Cover</a></li>
                    <li><a class="dropdown-item action-remove-first" href="#">Remove 1st Image</a></li>
                    <li><a class="dropdown-item action-edit" href="#">Edit File</a></li>
                    <li><a class="dropdown-item action-rebuild" href="#">Rebuild</a></li>
                    <li><a class="dropdown-item action-enhance" href="#">Enhance</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item action-delete text-danger" href="#"><i class="bi bi-trash"></i>
                            Delete</a></li>
                </ul>
            </div>
        </div>
    </div>
</template>
<!-- Edit CBZ Modal -->
<div class="modal fade" id="editCBZModal" tabindex="-1" aria-labelledby="editCBZModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCBZModalLabel">Editing CBZ File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editInlineContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                    <!-- Inline editing content (cards) will be dynamically loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveEditBtn" onclick="saveEditedCBZ()">
                    <i class="bi bi-floppy2-fill"></i> Save
                </button>
                <form action="/save" method="post" id="editInlineSaveForm" style="display: none;">
                    <input type="hidden" name="folder_name" id="editInlineFolderName">
                    <input type="hidden" name="zip_file_path" id="editInlineZipFilePath">
                    <input type="hidden" name="original_file_path" id="editInlineOriginalFilePath">
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Free Form Crop Modal -->
<div class="modal fade" id="freeFormCropModal" tabindex="-1" aria-labelledby="freeFormCropModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="freeFormCropModalLabel">Free Form Crop - Click and drag to select area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center bg-dark"
                style="overflow: hidden; position: relative;">
                <div id="cropImageContainer"
                    style="position: relative; display: inline-block; max-width: 100%; max-height: 100%; cursor: crosshair;">
                    <img id="cropImage" src="" alt="Image to crop"
                        style="max-width: 100%; max-height: 90vh; display: block; user-select: none;">
                    <div id="cropSelection"
                        style="position: absolute; border: 3px dashed #ff0000; background-color: rgba(255, 0, 0, 0.1); display: none; pointer-events: none;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCropBtn" onclick="confirmFreeFormCrop()"
                    disabled>Confirm Crop</button>
            </div>
        </div>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this file?</p>
                <div class="alert alert-warning">
                    <strong>File:</strong> <span id="deleteFileName"></span><br>
                    <strong>Size:</strong> <span id="deleteFileSize"></span><br>
                    <strong>Path:</strong> <span id="deleteFilePath" class="text-break"></span>
                </div>
                <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteFile()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Comic Reader Modal -->
<div id="comicReaderModal" class="comic-reader-modal" style="display: none;">
    <div class="comic-reader-overlay"></div>
    <div class="comic-reader-container">
        <!-- Header -->
        <div class="comic-reader-header">
            <div class="comic-reader-title" id="comicReaderTitle">Loading...</div>
            <div class="comic-reader-controls">
                <span class="comic-reader-page-info" id="comicReaderPageInfo">Page 1 of 1</span>
                <button class="btn btn-sm btn-outline-light" id="comicReaderClose" title="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <!-- Swiper -->
        <div class="swiper comic-reader-swiper" id="comicReaderSwiper">
            <div class="swiper-wrapper" id="comicReaderWrapper">
                <!-- Slides will be dynamically added here -->
            </div>
            <!-- Navigation -->
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
            <!-- Pagination -->
            <div class="swiper-pagination"></div>
        </div>
    </div>
</div>
<!-- CBZ Info Modal -->
<div class="modal fade" id="cbzInfoModal" tabindex="-1" aria-labelledby="cbzInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cbzInfoModalLabel">CBZ Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="cbzInfoContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading CBZ information...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- End of CBZ Info Modal -->
<!-- Missing File Check Results Modal -->
<div class="modal fade" id="missingFileCheckModal" tabindex="-1" aria-labelledby="missingFileCheckModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="missingFileCheckModalLabel">Missing File Check Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="missingFileCheckContent">
                    <!-- Summary Section -->
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading mb-2">
                            <i class="bi bi-info-circle"></i> Summary
                        </h6>
                        <p class="mb-0" id="missingFileCheckSummary"></p>
                    </div>

                    <!-- File Link Section -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-file-earmark-text"></i> Missing Issues File
                            </h6>
                            <p class="card-text">
                                A detailed list of missing issues has been saved to:
                            </p>
                            <div class="bg-light p-2 rounded mb-2">
                                <code id="missingFileCheckPath"></code>
                            </div>
                            <a href="#" id="missingFileCheckLink" class="btn btn-sm btn-primary" target="_blank">
                                <i class="bi bi-box-arrow-up-right"></i> View File
                            </a>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="alert alert-secondary mt-3 mb-0">
                        <small>
                            <i class="bi bi-lightbulb"></i>
                            This file will remain in the directory for your reference. You can access it anytime by
                            navigating to the folder.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Missing File Check Results Modal -->
<!-- Text File Viewer Modal -->
<div class="modal fade" id="textFileViewerModal" tabindex="-1" aria-labelledby="textFileViewerModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textFileViewerModalLabel">
                    <i class="bi bi-file-earmark-text"></i> <span id="textFileName">Text File</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="textFileContent" class="text-file-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading text file...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Text File Viewer Modal -->
<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="successToastBody">
                Success message
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="errorToastBody">
                Error message
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/collection.js') }}?v={{ range(1, 10000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Dashboard Swipers
        const swiperConfig = {
            slidesPerView: 'auto',
            spaceBetween: 15,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            }
        };

        // Initialize all dashboard swipers with the same config
        document.querySelectorAll('.dashboard-swiper').forEach(el => {
            new Swiper(el, swiperConfig);
        });

        // Dashboard visibility is handled by loadDirectory() in collection.js
    });
</script>
{% endblock %}