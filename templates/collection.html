{% extends 'base.html' %}
{% block title %}Browse Library{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/collection.css') }}?v={{ range(1, 10000) | random }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
{% endblock %}
{% block content %}
<div class="container-lg mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <nav aria-label="breadcrumb" class="flex-grow-1">
            <ol class="breadcrumb mb-0" id="breadcrumb">
                <li class="breadcrumb-item active">Loading...</li>
            </ol>
        </nav>
        <!-- View Toggle Buttons -->
        <div class="mx-3" id="viewToggleButtons">
            <button class="btn btn-outline-primary btn-sm" id="allBooksBtn" onclick="loadAllBooks()"
                style="display: none;">
                <i class="bi bi-collection"></i> All Books
            </button>
            <button class="btn btn-primary btn-sm" id="folderViewBtn" onclick="returnToFolderView()"
                style="display: none;">
                <i class="bi bi-folder"></i> Folder View
            </button>
        </div>
        <div class="d-flex align-items-center">
            <div class="input-group input-group-sm me-2">
                <label class="input-group-text" for="itemsPerPage">Per page</label>
                <select class="form-select" id="itemsPerPage" onchange="changeItemsPerPage(this.value)">
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="250">250</option>
                </select>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshCurrentView()" title="Refresh">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <!-- Filter Bar -->
    <div class="d-flex flex-wrap flex-md-nowrap gap-2 gap-md-3 mb-3">
        <div id="gridFilterButtons" style="display: none; flex: 1 1 auto;">
            <div class="btn-group btn-group-sm" role="group" aria-label="Filter by first letter">
                <!-- Filter buttons will be dynamically populated by JS -->
            </div>
        </div>
        <div id="gridSearchRow" style="flex: 0 0 auto; width: 100%; max-width: 250px;">
            <!-- Search input will be dynamically populated by JS -->
        </div>
    </div>
    <div id="loading-indicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div id="file-grid" class="file-grid" style="display: none;">
        <!-- Grid items will be populated by JS -->
    </div>
    <div id="empty-state" class="text-center py-5" style="display: none;">
        <i class="bi bi-folder2-open display-1 text-muted"></i>
        <p class="lead text-muted mt-3">This folder is empty</p>
    </div>
    <nav id="pagination-controls" aria-label="File browser pagination" class="mt-4" style="display: none;">
        <ul class="pagination justify-content-center" id="pagination-list">
            <!-- Pagination items will be populated by JS -->
        </ul>
    </nav>
</div>
<!-- Template for Grid Item -->
<template id="grid-item-template">
    <div class="grid-item" onclick="">
        <div class="thumbnail-container">
            <img src="" alt="" class="thumbnail" loading="lazy">
            <div class="icon-overlay">
                <i class="bi"></i>
            </div>
        </div>
        <div class="item-info d-flex justify-content-between align-items-start mt-2">
            <div class="item-details text-truncate flex-grow-1">
                <div class="item-name text-truncate" title=""></div>
                <div class="item-meta text-muted small"></div>
            </div>
            <div class="item-actions dropdown ms-2">
                <button class="btn btn-link btn-sm p-0 text-secondary no-propagation" type="button"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item action-crop" href="#">Crop Cover</a></li>
                    <li><a class="dropdown-item action-remove-first" href="#">Remove 1st Image</a></li>
                    <li><a class="dropdown-item action-edit" href="#">Edit File</a></li>
                    <li><a class="dropdown-item action-rebuild" href="#">Rebuild</a></li>
                    <li><a class="dropdown-item action-enhance" href="#">Enhance</a></li>
                </ul>
            </div>
        </div>
    </div>
</template>
<!-- Edit CBZ Modal -->
<div class="modal fade" id="editCBZModal" tabindex="-1" aria-labelledby="editCBZModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCBZModalLabel">Editing CBZ File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editInlineContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                    <!-- Inline editing content (cards) will be dynamically loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn" onclick="saveEditedCBZ()">
                    <i class="bi bi-floppy2-fill"></i> Save
                </button>
                <form action="/save" method="post" id="editInlineSaveForm" style="display: none;">
                    <input type="hidden" name="folder_name" id="editInlineFolderName">
                    <input type="hidden" name="zip_file_path" id="editInlineZipFilePath">
                    <input type="hidden" name="original_file_path" id="editInlineOriginalFilePath">
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Free Form Crop Modal -->
<div class="modal fade" id="freeFormCropModal" tabindex="-1" aria-labelledby="freeFormCropModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="freeFormCropModalLabel">Free Form Crop - Click and drag to select area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center bg-dark"
                style="overflow: hidden; position: relative;">
                <div id="cropImageContainer"
                    style="position: relative; display: inline-block; max-width: 100%; max-height: 100%; cursor: crosshair;">
                    <img id="cropImage" src="" alt="Image to crop"
                        style="max-width: 100%; max-height: 90vh; display: block; user-select: none;">
                    <div id="cropSelection"
                        style="position: absolute; border: 3px dashed #ff0000; background-color: rgba(255, 0, 0, 0.1); display: none; pointer-events: none;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCropBtn" onclick="confirmFreeFormCrop()"
                    disabled>Confirm Crop</button>
            </div>
        </div>
    </div>
</div>
<!-- Comic Reader Modal -->
<div id="comicReaderModal" class="comic-reader-modal" style="display: none;">
    <div class="comic-reader-overlay"></div>
    <div class="comic-reader-container">
        <!-- Header -->
        <div class="comic-reader-header">
            <div class="comic-reader-title" id="comicReaderTitle">Loading...</div>
            <div class="comic-reader-controls">
                <span class="comic-reader-page-info" id="comicReaderPageInfo">Page 1 of 1</span>
                <button class="btn btn-sm btn-outline-light" id="comicReaderClose" title="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <!-- Swiper -->
        <div class="swiper comic-reader-swiper" id="comicReaderSwiper">
            <div class="swiper-wrapper" id="comicReaderWrapper">
                <!-- Slides will be dynamically added here -->
            </div>
            <!-- Navigation -->
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
            <!-- Pagination -->
            <div class="swiper-pagination"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/collection.js') }}?v={{ range(1, 10000) | random }}"></script>
{% endblock %}