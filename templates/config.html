{% extends 'base.html' %}

{% block title %}CLU: Settings Page{% endblock %}

{% block content %}

<style>
    /* Spinning icon for cache operations */
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<div class="container-lg">
    <h2 class="text-primary-emphasis">App Settings</h2>
    <form method="POST" class="mt-4">
        
        <!-- Missing Issue Configuration -->
        <div class="container p-4 border rounded shadow-sm mb-4">
            <h4>Missing Issue Configuration</h4>
            <p class="text-muted">Update these settings to ignore terms or files when the app is performing a <strong>Missing Issue</strong> scan.</p>

            <div class="row">
                <div class="col-md-6">
                    <label for="ignored_terms" class="form-label">IGNORED TERMS:</label>
                    <input type="text" name="ignored_terms" id="ignored_terms" value="{{ ignored_terms }}" class="form-control">
                    <small class="form-text text-muted">
                        Enter words or terms to ignore while performing a Missing Issue search. Terms must be comma-separated.
                    </small>
                </div>

                <div class="col-md-6">
                    <label for="ignored_files" class="form-label">IGNORED FILES:</label>
                    <input type="text" name="ignored_files" id="ignored_files" value="{{ ignored_files }}" class="form-control">
                    <small class="form-text text-muted">
                        Enter comma-separated file names to ignore when checking for missing issues (e.g., cover.jpg, cvinfo).
                    </small>
                </div>
            </div>
        </div>

        <!-- Directory Processing Configuration -->
        <div class="container p-4 border rounded shadow-sm mb-4">
            <h4>Directory & File Processing Settings</h4>
            <p class="text-muted">Settings related to Directory processing features.</p>

             <!-- Checkboxes for Traverse Subdirectories -->
             <div class="row">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="convertSubdirectories" name="convertSubdirectories" {% if convertSubdirectories %}checked{% endif %}>
                        <label class="form-check-label" for="convertSubdirectories">{% if convertSubdirectories %}Disable{% else %}Enable{% endif %} Subdirectories for Conversion</label>
                        <small class="form-text text-muted">
                            <br />If enabled, when performing CBR --> CBZ conversion on a directory, CLU will convert all files in subdirectories as well.
                        </small>
                    </div>
                </div>

                <!-- Placeholder 
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="readSubdirectories" name="readSubdirectories" {% if readSubdirectories %}checked{% endif %}>
                        <label class="form-check-label" for="readSubdirectories">{% if readSubdirectories %}Disable{% else %}Enable{% endif %} Processing Sub-Directories</label>
                        <small class="form-text text-muted">
                            <br />If enabled, the app will process files in sub-directories of your <code>{{ watch }}</code> folder.
                        </small>
                    </div>
                </div> -->
            </div>
            <p class="text-muted">Settings related to Directory & File processing features.</p>
            <div class="row">
                <div class="col-md-6">
                    <label for="skippedFiles" class="form-label">SKIPPED FILE TYPES:</label>
                    <input type="text" name="skippedFiles" id="skippedFiles" value="{{ skippedFiles }}" class="form-control">
                    <small class="form-text text-muted">
                        When any operation unpacks a RAR/ZIP File, files with these extensions will be skipped. They will be re-added to the archive.
                    </small>
                </div>

                <div class="col-md-6">
                    <label for="deletedFiles" class="form-label">DELETED FILE TYPES:</label>
                    <input type="text" name="deletedFiles" id="deletedFiles" value="{{ deletedFiles }}" class="form-control">
                    <small class="form-text text-muted">
                        When any operation unpacks a RAR/ZIP File, files with these extensions will deleted before the file is re-packed.
                    </small>
                </div>
            </div>

        </div>

        <!-- Folder Monitoring Configuration -->
        <div class="container p-4 border rounded shadow-sm mb-4">
            <h4>Folder Monitoring</h4>
            <p class="text-muted">Configure the <code>Watched</code> and <code>Target</code> folders. Other monitoring features can be adjusted here as well.</p>

            <div class="row">
                <div class="col-md-6">
                    <label for="watch" class="form-label">WATCH:</label>
                    <input type="text" name="watch" id="watch" value="{{ watch }}" class="form-control">
                    <small class="form-text text-muted">
                        Enter the path to the directory to monitor for downloaded files.
                    </small>
                </div>

                <div class="col-md-6">
                    <label for="target" class="form-label">TARGET:</label>
                    <input type="text" name="target" id="target" value="{{ target }}" class="form-control">
                    <small class="form-text text-muted">
                        Enter the path where renamed files will be moved.
                    </small>
                </div>
            </div>

            <hr>

            <!-- Checkboxes for AutoConvert & Subdirectories -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="autoConvert" name="autoConvert" {% if autoConvert %}checked{% endif %}>
                        <label class="form-check-label" for="autoConvert">{% if autoConvert %}Disable{% else %}Enable{% endif %} Auto CBZ Conversion</label>
                        <small class="form-text text-muted">
                            <br />Enables auto-conversion of CBR/RAR files to CBZ in your Watch folder.
                        </small>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="readSubdirectories" name="readSubdirectories" {% if readSubdirectories %}checked{% endif %}>
                        <label class="form-check-label" for="readSubdirectories">{% if readSubdirectories %}Disable{% else %}Enable{% endif %} Processing Sub-Directories</label>
                        <small class="form-text text-muted">
                            <br />If enabled, the app will process files in sub-directories of your <code>{{ watch }}</code> folder.
                        </small>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="autoUnpack" name="autoUnpack" {% if autoUnpack %}checked{% endif %}>
                        <label class="form-check-label" for="autoUnpack">{% if autoUnpack %}Disable{% else %}Enable{% endif %} Auto ZIP Extraction</label>
                        <small class="form-text text-muted">
                            <br />When enabled, ZIP files placed in the Watch folder will automatically be unzipped.
                        </small>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="moveDirectory" name="moveDirectory" {% if moveDirectory %}checked{% endif %}>
                        <label class="form-check-label" for="moveDirectory">{% if moveDirectory %}Disable{% else %}Enable{% endif %} Move Sub-Directories</label>
                        <small class="form-text text-muted">
                            <br />If enabled, when processing files in your <code>{{ watch }}</code> folder, the sub-dirctories will be moved as well.
                        </small>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <label for="ignored_extensions" class="form-label">IGNORED EXTENSIONS:</label>
                    <input type="text" name="ignored_extensions" id="ignored_extensions" value="{{ ignored_extensions }}" class="form-control">
                    <small class="form-text text-muted">
                        Enter extensions to ignore when monitoring files (e.g., .tmp, .crdownload).
                    </small>
                </div>
            </div>            

        </div>

        <!-- Download API Settings -->
        <div class="container p-4 border rounded shadow-sm mb-4">
            <h4>API Download Configuration</h4>
            <p class="text-muted">These options, along with the Chrome extension, will let you `right-click` links and send them to CLU to be downloaded to your <code>/watch</code> folder.</p>

            <div class="row">
                <div class="col-md-12">
                    <label for="customHeaders" class="form-label">Custom Headers (JSON)</label>
                    <textarea class="form-control" id="customHeaders" name="customHeaders" rows="4" placeholder="JSON Custom Headers">{{ customHeaders }}</textarea>
                    <small class="form-text text-muted">
                        Similar to the Chrome Extension, enter any authentication details here that need to be passed to your URL/domain/Tunnel/VPN.
                    </small>
                </div>
            </div>
        </div>

        <!-- Performance & Timeout Settings -->
        <div class="container p-4 border rounded shadow-sm mb-4">
            <h4>Performance & Timeout Settings</h4>
            <p class="text-muted">Configure timeout settings for large file operations and performance optimizations.</p>

            <div class="row">
                <div class="col-md-6">
                    <label for="operationTimeout" class="form-label">Operation Timeout (seconds):</label>
                    <input type="number" name="operationTimeout" id="operationTimeout" value="{{ operationTimeout }}" class="form-control" min="300" max="7200">
                    <small class="form-text text-muted">
                        Timeout for large file operations (convert, rebuild). Default: 3600 seconds (1 hour). Minimum: 300 seconds (5 minutes).
                    </small>
                </div>

                <div class="col-md-6">
                    <label for="largeFileThreshold" class="form-label">Large File Threshold (MB):</label>
                    <input type="number" name="largeFileThreshold" id="largeFileThreshold" value="{{ largeFileThreshold }}" class="form-control" min="100" max="2000">
                    <small class="form-text text-muted">
                        Files larger than this size (in MB) will get enhanced progress reporting. Default: 500 MB.
                    </small>
                </div>
            </div>
        </div>

        <!-- Cache Management Settings -->
        <div class="container p-4 border rounded shadow-sm mb-4">
            <h4>Cache Management</h4>
            <p class="text-muted">
                Manage the application's directory cache and search index. The cache automatically rebuilds every 6 hours to ensure data accuracy.
                <br><br>
                <strong>How it works:</strong> When you browse directories, the app caches the listing for 5 seconds to improve performance. 
                If files change (downloads, moves, etc.), the cache is automatically invalidated. The search index provides fast file searching 
                across your entire data directory.
            </p>

            <!-- Cache Status Display -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Cache Status:</strong><br>
                                <span id="cacheStatus">Checking...</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Data Directory:</strong><br>
                                <span id="dataDirStatus">Checking...</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Next Rebuild:</strong><br>
                                <span id="nextRebuild">Calculating...</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <small class="text-muted">
                                    <span id="cacheDetails">Loading cache details...</span>
                                </small>
                            </div>
                        </div>
                        <div class="row mt-1">
                            <div class="col-md-12">
                                <small class="text-muted">
                                    <span id="cachePerformance">Loading performance info...</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache Management Buttons -->
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary w-100" onclick="rebuildCache()" title="Rebuild cache and search index">
                        <i class="bi bi-arrow-clockwise"></i> Rebuild Cache
                    </button>
                    <small class="form-text text-muted">
                        Manually rebuild the entire directory cache and search index. This will clear all cached data and rebuild it from scratch.
                    </small>
                </div>

                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearCache()" title="Clear directory cache">
                        <i class="bi bi-trash"></i> Clear Cache
                    </button>
                    <small class="form-text text-muted">
                        Clear the directory cache only. This will force the next directory listing to rebuild the cache, but won't affect the search index.
                    </small>
                </div>
            </div>

            <!-- Cache Configuration -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="cacheRebuildInterval" class="form-label">Cache Rebuild Interval (hours):</label>
                    <input type="number" name="cacheRebuildInterval" id="cacheRebuildInterval" value="6" class="form-control" min="1" max="24" readonly>
                    <small class="form-text text-muted">
                        How often the cache automatically rebuilds. Currently set to 6 hours and cannot be changed from the UI.
                    </small>
                </div>

                <div class="col-md-4">
                    <label for="cacheDuration" class="form-label">Cache Duration (seconds):</label>
                    <input type="number" name="cacheDuration" id="cacheDuration" value="5" class="form-control" min="1" max="60" readonly>
                    <small class="form-text text-muted">
                        How long individual directory listings are cached. Currently set to 5 seconds and cannot be changed from the UI.
                    </small>
                </div>

                <div class="col-md-4">
                    <label for="maxCacheSize" class="form-label">Maximum Cache Size:</label>
                    <input type="number" name="maxCacheSize" id="maxCacheSize" value="100" class="form-control" readonly>
                    <small class="form-text text-muted">
                        Maximum number of directories that can be cached in memory. Currently set to 100 and cannot be changed from the UI.
                    </small>
                </div>
            </div>
        </div>

        <!-- ComicInfo XML editing Configuration -->
        <div class="container p-4 border rounded shadow-sm mb-4">
            <h4>ComicInfo.XML Update Settings</h4>
            <p class="text-muted">Enable/Disable features for updating or cleaning <code>ComicInfo.xml</code> files. This proecess runs on a single directory, extracts the <code>ComicInfo.xml</code> file, reads and makes updates and then recompresses the file.</p>

            <!-- Checkboxes for ComicInfo.xml options -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="xmlYear" name="xmlYear" {% if xmlYear %}checked{% endif %}>
                        <label class="form-check-label" for="xmlYear">{% if xmlYear %}Disable{% else %}Enable{% endif %} Update Volume to First Issue Year</label>
                        <small class="form-text text-muted">
                            <br />Reads the alpha-numeric first file in the directory and attempts to extract the 4-digit year from the filename.
                        </small>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input xml-checkbox" type="checkbox" role="switch" id="xmlMarkdown" name="xmlMarkdown" {% if xmlMarkdown %}checked{% endif %}>
                        <label class="form-check-label" for="xmlMarkdown">{% if xmlMarkdown %}Disable{% else %}Enable{% endif %} Removing ALL Markdown Content from Comments</label>
                        <small class="form-text text-muted">
                            <br />If enabled, when the ComicInfo.xml update function is run, the <code>Comments</code> will have all headers, bold text and tables removed.
                        </small>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input xml-checkbox" type="checkbox" role="switch" id="xmlList" name="xmlList" {% if xmlList %}checked{% endif %}>
                        <label class="form-check-label" for="xmlList">{% if xmlList %}Disable{% else %}Enable{% endif %} Removing 'Covers & Creators' table from Comments</label>
                        <small class="form-text text-muted">
                            <br />If enabled, when the ComicInfo.xml update function is run, 'Covers & Creators' tables will be removed from the <code>Comments</code>.
                        </small>
                    </div>
                </div>

            </div>
        </div>

        <!-- Save Button -->
        <div class="mb-3 text-center">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-floppy"></i> Save
            </button>
        </div>
    </form>

    <!-- Restart Button -->
    <div class="container p-4 border rounded shadow-sm text-center">
        <h6>Restart Flask App</h6>
        <button onclick="restartApp()" class="btn btn-secondary">Restart App</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function restartApp() {
        fetch('/restart', { method: 'POST' })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => console.error('Error:', error));
    }
    
    document.addEventListener("DOMContentLoaded", function () {
        const xmlCheckboxes = document.querySelectorAll(".xml-checkbox");

       xmlCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                if (this.checked) {
                    xmlCheckboxes.forEach(cb => {
                        if (cb !== this) {
                            cb.checked = false;
                        }
                    });
                }
            });
        });

        // Initialize cache status display
        updateCacheStatus();
        
        // Update cache status every minute
        setInterval(updateCacheStatus, 60000);
    });

    // Cache Management Functions
    function rebuildCache() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Rebuilding...';
        button.disabled = true;
        
        fetch('/rebuild-cache', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Cache Rebuilt', data.message, 'success');
                // Update cache status display
                updateCacheStatus();
            } else {
                showToast('Cache Rebuild Failed', data.error || 'Unknown error', 'error');
            }
        })
        .catch(error => {
            console.error('Error rebuilding cache:', error);
            showToast('Cache Rebuild Failed', 'Network error occurred', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    function clearCache() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="bi bi-trash"></i> Clearing...';
        button.disabled = true;
        
        fetch('/clear-cache', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Cache Cleared', 'Directory cache cleared successfully', 'success');
                // Update cache status display
                updateCacheStatus();
            } else {
                showToast('Cache Clear Failed', data.error || 'Unknown error', 'error');
            }
        })
        .catch(error => {
            console.error('Error clearing cache:', error);
            showToast('Cache Clear Failed', 'Network error occurred', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // Update cache status display
    function updateCacheStatus() {
        fetch('/cache-status')
            .then(response => response.json())
            .then(data => {
                const cacheStatusEl = document.getElementById('cacheStatus');
                const dataDirStatusEl = document.getElementById('dataDirStatus');
                const nextRebuildEl = document.getElementById('nextRebuild');
                const cacheDetailsEl = document.getElementById('cacheDetails');
                const cachePerformanceEl = document.getElementById('cachePerformance');
                
                if (cacheStatusEl && nextRebuildEl && dataDirStatusEl && cacheDetailsEl && cachePerformanceEl) {
                    // Update cache status with more detail
                    const cachedDirs = data.cache_size;
                    const totalDirs = data.total_directories || 'Unknown';
                    const statusText = `${cachedDirs}/${totalDirs} dirs cached | Last: ${data.formatted_since} ago`;
                    cacheStatusEl.textContent = statusText;
                    
                    // Update data directory status
                    if (data.data_dir_stats) {
                        const stats = data.data_dir_stats;
                        const dirStatusText = `${stats.subdir_count} subdirs | ${stats.total_files} files`;
                        dataDirStatusEl.textContent = dirStatusText;
                    } else {
                        dataDirStatusEl.textContent = 'Loading...';
                    }
                    
                    // Update next rebuild time
                    if (data.time_until_next > 0) {
                        nextRebuildEl.textContent = `in ${data.formatted_until}`;
                    } else {
                        nextRebuildEl.textContent = 'Due now';
                    }
                    
                    // Update cache details
                    let detailsText = '';
                    if (data.cache_invalidated) {
                        detailsText += 'âš ï¸ Cache was recently invalidated by file changes. ';
                    }
                    if (data.index_built) {
                        detailsText += 'âœ… Search index is ready. ';
                    } else {
                        detailsText += 'â³ Building search index... ';
                    }
                    detailsText += `Cache duration: ${data.cache_duration || 5}s | Max cache size: ${data.max_cache_size || 100}`;
                    
                    cacheDetailsEl.textContent = detailsText;
                    
                    // Update cache performance information
                    const cacheHitRate = data.total_directories > 0 ? 
                        Math.round((data.cache_size / data.total_directories) * 100) : 0;
                    let performanceText = `Cache hit rate: ${cacheHitRate}% | `;
                    
                    if (data.cache_size >= data.max_cache_size) {
                        performanceText += 'âš ï¸ Cache at maximum size | ';
                    }
                    
                    if (data.cache_size === 0) {
                        performanceText += 'ðŸ”„ Cache is empty, will rebuild on next access';
                    } else {
                        performanceText += `Cache efficiency: ${data.cache_size}/${data.max_cache_size}`;
                    }
                    
                    cachePerformanceEl.textContent = performanceText;
                }
            })
            .catch(error => {
                console.error('Error fetching cache status:', error);
                const cacheStatusEl = document.getElementById('cacheStatus');
                const dataDirStatusEl = document.getElementById('dataDirStatus');
                const nextRebuildEl = document.getElementById('nextRebuild');
                const cacheDetailsEl = document.getElementById('cacheDetails');
                const cachePerformanceEl = document.getElementById('cachePerformance');
                
                if (cacheStatusEl) cacheStatusEl.textContent = 'Error loading status';
                if (dataDirStatusEl) dataDirStatusEl.textContent = 'Error loading status';
                if (nextRebuildEl) nextRebuildEl.textContent = 'Unknown';
                if (cacheDetailsEl) cacheDetailsEl.textContent = 'Error loading cache details';
                if (cachePerformanceEl) cachePerformanceEl.textContent = 'Error loading performance info';
            });
    }

    // Helper function to show toast notifications
    function showToast(title, message, type = 'info') {
        // Create toast element
        const toastHtml = `
            <div class="toast bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} text-white" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} text-white">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = '1100';
            document.body.appendChild(toastContainer);
        }
        
        const toastElement = document.createElement('div');
        toastElement.innerHTML = toastHtml;
        toastContainer.appendChild(toastElement.firstElementChild);
        
        // Show the toast
        const toast = new bootstrap.Toast(toastElement.firstElementChild);
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement.firstElementChild.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
</script>
{% endblock %}