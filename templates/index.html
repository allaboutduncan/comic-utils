<!-- templates/index.html -->
{% extends 'base.html' %}

{% block title %}CLU (Comic Library Utilities){% endblock %}

{% block content %}

<div class="container-lg">      
    <form class="mt-4" onsubmit="event.preventDefault();">

        <label for="selected-directory" class="form-label">Select Your Directory:</label>
        <div class="input-group mb-3">
            <button id="browse-btn" type="button" class="btn btn-outline-primary" onclick="openDirectoryModal()">
                <i class="bi bi-folder-symlink-fill"></i>
                Browse</button>
            <input type="text" id="selected-directory" name="selected_directory" class="form-control" value="/data">
        </div>

        <!-- Bootstrap Cards for Script Options -->
        <div class="row p-3 collapse.show" id="multiple">
            <h2 class="text-primary-emphasis">Full Directory Options</h2>
            <!-- Rename Directory -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Rename Files</h5>
                        <p class="card-text">Rename all files in a directory (including sub-directories).</p>
                        <p class="card-text fw-light">Uses {Series Name} {Issue Number} ({Year}) pattern.</p>
                        <button type="button" id="btn-rename" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('rename')">Run Rename</button>
                    </div>
                </div>
            </div>
            <!-- Convert Directory -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Convert Directory</h5>
                        <p class="card-text">Convert all RAR/CBR files in a directory to CBZ.</p>
                        {% if convertSubdirectories %}
                        <p class="card-text fw-light">Sub-Directory conversion is enabled, performing CBR --> CBZ conversion on a directory will convert all files in sub-directories as well</p>
                        {% endif %}
                        <button type="button" id="btn-convert" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('convert')">Run Convert</button>
                    </div>
                </div>
            </div>
            <!-- Rebuild Full Directory -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Rebuild Directory</h5>
                        <p class="card-text">Rebuild all files in a directory to CBZ.</p>
                        <button type="button" id="btn-rebuild" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('rebuild')">Run Rebuild</button>
                    </div>
                </div>
            </div>
            <!-- Convert PDFs to CBZ -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Convert PDFs to CBZ</h5>
                        <p class="card-text">Convert all PDFs in the directory to CBZ format.</p>
                        <button type="button" id="btn-pdf" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('pdf')">Run PDF Conversion</button>
                    </div>
                </div>
            </div>
            <!-- Check for Missing Files -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Missing File Check</h5>
                        <p class="card-text">Check the directory for any missing files.</p>
                        <button type="button" id="btn-missing" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('missing')">Run Check</button>
                    </div>
                </div>
            </div>
            <!-- Enhance Images in Directory -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Enhance Images</h5>
                        <p class="card-text">Unzips and runs image enhancement logic on all CBZ files in a direcotry.</p>
                        <button type="button" id="btn-enhance_dir" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('enhance_dir')">Enhance Images</button>
                    </div>
                </div>
            </div>
            <!-- row 3 of directory options -->
            <!-- Clean ComicInfo.xml -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Update ComicInfo.xml</h5>
                        <p class="card-text">Updates <code>ComicInfo.xml</code> for each file in a directory based on your config settings.</p>
                        <p class="card-text fw-light">Note: This is not enabled for sub-directories and must be run for each directory.</p>
                        <button type="button" id="btn-comicinfo" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('comicinfo')">Update ComicInfo.xml</button>
                    </div>
                </div>
            </div>            
        </div>        
        <!-- row for single file operations -->
        <div class="row p-3 collapse" id="single">
            <h2 class="text-primary-emphasis">Single File Options</h2>
            <!-- Single File Rebuild -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Single File Rebuild</h5>
                        <p class="card-text">Rebuild/Convert a single file within the directory.</p>
                        <p class="card-text fw-light">Rebuild troublesome CBZ files or convert a single RAR/CBR file to CBZ.</p>
                        <button type="button" id="btn-single_file" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('single_file')">Run Rebuild</button>
                    </div>
                </div>
            </div>
            <!-- Crop Cover -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Crop Cover</h5>
                        <p class="card-text">Crop the cover image of the comic.</p>
                        <p class="card-text fw-light">Quick action to crop a front/back wrapped cover to just the front, saving the original image as well.</p>
                        <button type="button" id="btn-crop" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('crop')">Run Crop</button>
                    </div>
                </div>
            </div>
            <!-- Remove 1st Image -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Remove 1st Image</h5>
                        <p class="card-text">Remove the first image from the comic.</p>
                        <button type="button" id="btn-remove" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('remove')">Run Remove</button>
                    </div>
                </div>
            </div>
            <!-- Edit CBZ File -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Edit CBZ File</h5>
                        <p class="card-text">Open the files in a modal and indivudually edit</p>
                        <p class="card-text fw-light">Perform multiple crop actions and delete unwanted images from files.</p>
                        <button type="button" id="btn-edit" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('edit')">Edit CBZ</button>
                    </div>
                </div>
            </div>
            <!-- Add Blank Image at End -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Add Blank Image at End</h5>
                        <p class="card-text">Add a blank image at the end of the comic.</p>
                        <button type="button" id="btn-add" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('add')">Run Add</button>
                    </div>
                </div>
            </div>
            <!-- Enhance Images in Directory -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Enhance Images</h5>
                        <p class="card-text">Unzips and runs image enhancement logic on a SINGLE CBZ file.</p>
                        <button type="button" id="btn-enhance_single" class="btn btn-primary mt-auto run-script-btn" onclick="runScript('enhance_single')">Enhance Images</button>
                    </div>
                </div>
            </div>          
            <!-- Delete File -->
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Delete File</h5>
                        <p class="card-text">Delete the specified file.</p>
                        <button type="button" id="btn-delete" class="btn btn-danger mt-auto run-script-btn" onclick="runScript('delete')">Delete File</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Inline Edit v2 -->
    <div class="row p-3 collapse" id="edit">
        <h2 class="text-primary-emphasis">Editing CBZ File</h2>
        <div id="editInlineContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 border border-primary-subtle rounded-2 bg-light text-dark">
            <!-- Inline editing content (cards) will be dynamically loaded here -->
        </div>
    
        <form action="/save" method="post" id="editInlineSaveForm">
            <input type="hidden" name="folder_name" id="editInlineFolderName">
            <input type="hidden" name="zip_file_path" id="editInlineZipFilePath">
            <input type="hidden" name="original_file_path" id="editInlineOriginalFilePath">
            <button type="submit" class="btn btn-primary mt-3">
                <i class="bi bi-floppy2-fill"></i>
                Save
            </button>
        </form>
    </div>

    <!-- Progress indicator -->
    <div class="row p-3" id="progress-container" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Processing Progress</h5>
                    <button type="button" class="btn-close" onclick="hideProgressIndicator()" aria-label="Close"></button>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    <div id="progress-text" class="text-muted">Initializing...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs container with Bootstrap classes -->
    <div class="row p-3">
        <div id="liveAlertPlaceholder"></div>
        <div id="logs" class="mt-4 p-3 border rounded" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap;"></div>
    </div>

    {% if monitor == "yes" %}
    <div class="row p-3">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-folder-check"></i> Folder Monitoring is enabled on <strong>{{ watch }}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
    {% endif %}

</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="confirmDeleteModalLabel" class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the following file?</p>
                <p><strong id="filePathToDelete"></strong></p>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeletion()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Directory Selection Modal -->
<div class="modal fade" id="directoryModal" tabindex="-1" aria-labelledby="directoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Library's Root Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <!-- Filter buttons for source panel -->
            <div id="source-directory-filter" class="mb-2">
                <div class="btn-group d-grid" role="group" aria-label="Directory Filter" style="grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));">
                <!-- Dynamically inserted buttons go here -->
                </div>
            </div>
                <p id="current-path-display" class="fw-bold">/data</p>
                <ul id="directory-list" class="list-group">
                    <!-- Directories will be loaded here dynamically -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="selectDirectory()" data-bs-dismiss="modal">Choose</button>
            </div>
        </div>
    </div>
</div>

<!-- Free Form Crop Modal -->
<div class="modal fade" id="freeFormCropModal" tabindex="-1" aria-labelledby="freeFormCropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="freeFormCropModalLabel">Free Form Crop - Click and drag to select area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center bg-dark" style="overflow: hidden; position: relative;">
                <div id="cropImageContainer" style="position: relative; display: inline-block; max-width: 100%; max-height: 100%; cursor: crosshair;">
                    <img id="cropImage" src="" alt="Image to crop" style="max-width: 100%; max-height: 90vh; display: block; user-select: none;">
                    <div id="cropSelection" style="position: absolute; border: 3px dashed #ff0000; background-color: rgba(255, 0, 0, 0.1); display: none; pointer-events: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCropBtn" onclick="confirmFreeFormCrop()" disabled>Confirm Crop</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/index.js') }}?v={{ range(1000, 9999) | random }}&t=202510"></script>
{% endblock %}
