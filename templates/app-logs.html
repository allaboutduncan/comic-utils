{% extends 'base.html' %}

{% block title %}Logs{% endblock %}

{% block content %}
<div class="container-lg">
    <h1 class="text-center">
        App Logs
    </h1>
    <div class="mb-2">
        <span id="log-status" class="badge bg-secondary">Connecting...</span>
        <span class="text-muted ms-2">(showing last 1000 lines + live updates)</span>
    </div>
    <pre id="log-output" style="border:1px solid #ccc; padding:10px; height:600px; overflow:auto; background-color: black; color: white;"></pre>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const logOutput = document.getElementById('log-output');
            const logStatus = document.getElementById('log-status');
            const eventSource = new EventSource('/stream/app');
            let firstMessage = true;

            eventSource.onopen = function() {
                logStatus.textContent = 'Connected';
                logStatus.className = 'badge bg-success';
            };

            eventSource.onmessage = function(event) {
                if (firstMessage) {
                    // Clear "loading" content on first real message
                    logOutput.textContent = '';
                    firstMessage = false;
                }
                logOutput.textContent += event.data + "\n";
                // Auto-scroll to bottom on new messages
                logOutput.scrollTop = logOutput.scrollHeight;
            };

            eventSource.onerror = function(error) {
                console.error("EventSource failed: ", error);
                logStatus.textContent = 'Connection Error';
                logStatus.className = 'badge bg-danger';
                // Try to reconnect after 5 seconds
                setTimeout(() => {
                    logStatus.textContent = 'Reconnecting...';
                    logStatus.className = 'badge bg-warning';
                }, 5000);
            };
        });
    </script>
{% endblock %}
