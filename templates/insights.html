{% extends "base.html" %}

{% block title %}Library Insights{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/insights.css') }}">
{% endblock %}

{% block content %}
<div class="container-lg insights-page">
    <!-- Page Header -->
    <div class="insights-header">
        <h1><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Library Insights</h1>
        <p class="lead mb-0">Explore your collection statistics and reading habits</p>
    </div>

    <!-- Top Stats Row -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <div class="stat-value">{{ "{:,}".format(library_stats.total_files) }}</div>
                <div class="stat-label">Total Files</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="bi bi-hdd"></i>
                </div>
                {% set size_gb = library_stats.total_size / (1024*1024*1024) %}
                <div class="stat-value">{% if size_gb > 999 %}{{ (size_gb / 1024)|round(2) }}<small
                        class="fs-6 fw-normal"> TB</small>{% else %}{{ size_gb|round(1) }}<small class="fs-6 fw-normal">
                        GB</small>{% endif %}</div>
                <div class="stat-label">Total Size</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon info">
                    <i class="bi bi-folder"></i>
                </div>
                <div class="stat-value">{{ "{:,}".format(library_stats.total_directories) }}</div>
                <div class="stat-label">Folders</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="bi bi-book"></i>
                </div>
                <div class="stat-value">{{ "{:,}".format(library_stats.total_read) }}</div>
                <div class="stat-label">Issues Read</div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-5">
            <div class="section-card">
                <div class="section-card-header">
                    <h3><i class="bi bi-pie-chart"></i>File Types</h3>
                </div>
                <div class="section-card-body">
                    <div class="chart-container">
                        <canvas id="fileTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="section-card">
                <div class="section-card-header">
                    <h3><i class="bi bi-activity"></i>Reading Activity</h3>
                </div>
                <div class="section-card-body">
                    <div class="chart-container">
                        <canvas id="readingHistoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Publishers Chart -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="section-card">
                <div class="section-card-header">
                    <h3><i class="bi bi-building"></i>Top Publishers</h3>
                </div>
                <div class="section-card-body">
                    <div class="chart-container tall">
                        <canvas id="publishersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recently Read Section -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="section-card">
                <div class="section-card-header">
                    <h3><i class="bi bi-clock-history"></i>Recently Read</h3>
                </div>
                <div class="section-card-body">
                    <div id="recently-read-grid" class="recently-read-grid">
                        <!-- Loaded via JavaScript -->
                    </div>
                    <div id="recently-read-empty" class="empty-state" style="display: none;">
                        <i class="bi bi-journal-x d-block"></i>
                        <p class="mb-0">No recently read comics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 20 Series by Issue Count -->
    <div class="row g-4 mb-4">
        <div class="col-6">
            <div class="section-card">
                <div class="section-card-header">
                    <h3><i class="bi bi-collection"></i> Top 20 Series by Issue Count</h3>
                </div>
                <div class="section-card-body">
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="topSeriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 20 Largest Comics -->

        <div class="col-6">
            <div class="section-card">
                <div class="section-card-header">
                    <h3><i class="bi bi-file-earmark-zip"></i> Top 20 Largest Comics</h3>
                </div>
                <div class="section-card-body">
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="largestComicsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get computed styles for theme colors
        const computedStyle = getComputedStyle(document.documentElement);

        // Helper to get CSS variable value
        function getCssVar(name, fallback) {
            const value = computedStyle.getPropertyValue(name).trim();
            return value || fallback;
        }

        // Helper to convert CSS color to rgba with opacity
        function colorWithOpacity(cssVar, fallback, opacity) {
            const color = getCssVar(cssVar, fallback);
            // If it's already rgba or rgb, parse and modify
            if (color.startsWith('rgb')) {
                return color.replace('rgb', 'rgba').replace(')', `, ${opacity})`);
            }
            // For hex colors, convert to rgba
            if (color.startsWith('#')) {
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color;
        }

        // Theme-aware colors from Bootstrap
        const primaryColor = getCssVar('--bs-primary', '#0d6efd');
        const successColor = getCssVar('--bs-success', '#198754');
        const infoColor = getCssVar('--bs-info', '#0dcaf0');
        const warningColor = getCssVar('--bs-warning', '#ffc107');
        const dangerColor = getCssVar('--bs-danger', '#dc3545');
        const secondaryColor = getCssVar('--bs-secondary', '#6c757d');

        const textColor = getCssVar('--bs-body-color', '#212529');
        const gridColor = getCssVar('--bs-border-color', 'rgba(0, 0, 0, 0.1)');

        // Chart.js global defaults for theme
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;
        Chart.defaults.font.family = getCssVar('--bs-body-font-family',
            "'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif");

        // Color palette for charts (theme-aware)
        const chartColors = [
            primaryColor,
            successColor,
            warningColor,
            infoColor,
            dangerColor,
            secondaryColor
        ];

        // ===== FILE TYPE CHART =====
        const fileTypes = {{ file_types | tojson
    }};
    const fileTypeLabels = fileTypes.map(item => item.type.toUpperCase());
    const fileTypeData = fileTypes.map(item => item.count);

    new Chart(document.getElementById('fileTypeChart'), {
        type: 'doughnut',
        data: {
            labels: fileTypeLabels,
            datasets: [{
                data: fileTypeData,
                backgroundColor: chartColors,
                borderWidth: 0,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 16,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: { size: 12 }
                    }
                }
            },
            cutout: '65%'
        }
    });

    // ===== READING HISTORY CHART =====
    const readingHistory = {{ reading_history | tojson }};
    // Support both daily (date field) and monthly (month field) data
    const historyLabels = readingHistory.map(item => item.date || item.month);
    const historyData = readingHistory.map(item => item.count);

    new Chart(document.getElementById('readingHistoryChart'), {
        type: 'line',
        data: {
            labels: historyLabels,
            datasets: [{
                label: 'Issues Read',
                data: historyData,
                borderColor: primaryColor,
                backgroundColor: colorWithOpacity('--bs-primary', '#0d6efd', 0.15),
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: historyData.length > 60 ? 0 : 3,
                pointHoverRadius: 5,
                pointBackgroundColor: primaryColor,
                pointBorderColor: getCssVar('--bs-body-bg', '#fff'),
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function (context) {
                            return context[0].label;
                        },
                        label: function (context) {
                            const count = context.parsed.y;
                            return count === 1 ? '1 issue' : `${count} issues`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: { size: 11 }
                    },
                    grid: {
                        color: gridColor,
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        font: { size: 10 },
                        maxRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: 12
                    },
                    grid: { display: false }
                }
            }
        }
    });

    // ===== PUBLISHERS CHART =====
    const topPublishers = {{ top_publishers | tojson }};
    const publisherLabels = topPublishers.map(item => item.name);
    const publisherData = topPublishers.map(item => item.count);

    new Chart(document.getElementById('publishersChart'), {
        type: 'bar',
        data: {
            labels: publisherLabels,
            datasets: [{
                label: 'Files',
                data: publisherData,
                backgroundColor: colorWithOpacity('--bs-success', '#198754', 0.7),
                hoverBackgroundColor: successColor,
                borderRadius: 4,
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: { size: 11 }
                    },
                    grid: {
                        color: gridColor,
                        drawBorder: false
                    }
                },
                y: {
                    ticks: { font: { size: 12 } },
                    grid: { display: false }
                }
            }
        }
    });

    // ===== TOP 20 LARGEST COMICS =====
    const largestComicsData = {{ largest_comics | tojson }};
    if (largestComicsData && largestComicsData.length > 0) {
        new Chart(document.getElementById('largestComicsChart'), {
            type: 'bar',
            data: {
                labels: largestComicsData.map(c => c.name.length > 45 ? c.name.substring(0, 45) + '...' : c.name),
                datasets: [{
                    label: 'Size (MB)',
                    data: largestComicsData.map(c => (c.size / 1024 / 1024).toFixed(1)),
                    backgroundColor: colorWithOpacity('--bs-info', '#0dcaf0', 0.7),
                    hoverBackgroundColor: getCssVar('--bs-info', '#0dcaf0'),
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.parsed.x + ' MB';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: { size: 11 },
                            callback: function (value) {
                                return value + ' MB';
                            }
                        },
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        }
                    },
                    y: {
                        ticks: { font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // ===== TOP 20 SERIES BY ISSUE COUNT =====
    const topSeriesData = {{ top_series | tojson }};
    if (topSeriesData && topSeriesData.length > 0) {
        new Chart(document.getElementById('topSeriesChart'), {
            type: 'bar',
            data: {
                labels: topSeriesData.map(s => s.name.length > 45 ? s.name.substring(0, 45) + '...' : s.name),
                datasets: [{
                    label: 'Issues',
                    data: topSeriesData.map(s => s.count),
                    backgroundColor: colorWithOpacity('--bs-warning', '#ffc107', 0.7),
                    hoverBackgroundColor: getCssVar('--bs-warning', '#ffc107'),
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.parsed.x + ' issues';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: { size: 11 }
                        },
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        }
                    },
                    y: {
                        ticks: { font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // ===== RECENTLY READ =====
    loadRecentlyRead();
});

    async function loadRecentlyRead() {
        try {
            const response = await fetch('/api/recently-read?limit=22');
            const items = await response.json();

            const grid = document.getElementById('recently-read-grid');
            const empty = document.getElementById('recently-read-empty');

            if (items.length === 0) {
                grid.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            grid.innerHTML = items.map(item => `
            <div class="recently-read-item"
                 onclick="window.location.href='/collection?path=${encodeURIComponent(item.path.substring(0, item.path.lastIndexOf('/')))}'">
                <img class="recently-read-thumbnail"
                     src="${item.thumbnail_url}"
                     alt="${escapeHtml(item.name)}"
                     title="${escapeHtml(item.name)}"
                     loading="lazy"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 150%22%3E%3Crect fill=%22%23dee2e6%22 width=%22100%22 height=%22150%22/%3E%3Ctext x=%2250%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%236c757d%22 font-size=%2210%22%3ENo Image%3C/text%3E%3C/svg%3E'">
            </div>
        `).join('');
        } catch (err) {
            console.error('Failed to load recently read:', err);
            document.getElementById('recently-read-empty').style.display = 'block';
            document.getElementById('recently-read-grid').style.display = 'none';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatReadDate(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays}d ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
        return date.toLocaleDateString();
    }
</script>
{% endblock %}