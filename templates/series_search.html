{% extends "base.html" %}

{% block title %}Series Search{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4 fade-in-down">
        <div>
            <h2 class="display-4 fw-bold mb-1">Series Search</h2>
            <p class="text-muted lead mb-0">Search the Metron database for comic series</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('pull_list') }}" class="btn btn-outline-primary">
                <i class="bi bi-list-check me-1"></i>Pull List
            </a>
        </div>
    </div>

    {% if not metron_configured %}
    <!-- Metron Not Configured Warning -->
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Metron credentials not configured.</strong>
        Please add your Metron username and password in
        <a href="{{ url_for('config_page') }}" class="alert-link">Settings</a> to use this feature.
    </div>
    {% else %}

    <!-- Search Card -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Enter series name..."
                            onkeypress="if(event.key==='Enter')doSeriesSearch()">
                        <button class="btn btn-primary" type="button" onclick="doSeriesSearch()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <span class="text-muted" id="resultCount"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Row (appears after search) -->
    <div class="card border-0 shadow-sm mb-4" id="filterCard" style="display: none;">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-funnel"></i></span>
                        <input type="text" class="form-control" id="filterInput" placeholder="Filter results...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card border-0 shadow-sm" id="resultsCard" style="display: none;">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="seriesTable">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="ps-4 sortable" data-sort="name" style="cursor: pointer;">
                                Series <i class="bi bi-chevron-expand text-muted ms-1"></i>
                            </th>
                            <th scope="col" class="text-center sortable" data-sort="issues" style="cursor: pointer;">
                                Issues <i class="bi bi-chevron-expand text-muted ms-1"></i>
                            </th>
                            <th scope="col" class="sortable" data-sort="year" style="cursor: pointer;">
                                Year Began <i class="bi bi-chevron-expand text-muted ms-1"></i>
                            </th>
                            <th scope="col" class="sortable" data-sort="volume" style="cursor: pointer;">
                                Volume <i class="bi bi-chevron-expand text-muted ms-1"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="seriesTableBody">
                        <!-- Rows populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="text-center py-5" id="loadingState" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Searching Metron database...</p>
    </div>

    <!-- Empty State (initial) -->
    <div class="text-center py-5 fade-in-up" id="emptyState">
        <div class="mb-4">
            <i class="bi bi-search display-1 text-muted opacity-25"></i>
        </div>
        <h3 class="h2 text-muted mb-3">Search for Series</h3>
        <p class="text-muted mb-4 lead">Enter a series name above to search the Metron database.</p>
    </div>

    <!-- No Results State -->
    <div class="text-center py-5" id="noResultsState" style="display: none;">
        <div class="mb-4">
            <i class="bi bi-emoji-frown display-1 text-muted opacity-25"></i>
        </div>
        <h3 class="h2 text-muted mb-3">No Results Found</h3>
        <p class="text-muted mb-4 lead">Try a different search term.</p>
    </div>

    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Store all results for filtering
        let allResults = [];
        let currentSort = { column: null, ascending: true };

        // Search function
        window.doSeriesSearch = async function () {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            // Show loading, hide other states
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('noResultsState').style.display = 'none';
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('filterCard').style.display = 'none';
            document.getElementById('resultCount').textContent = '';

            try {
                const response = await fetch(`/api/series/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                document.getElementById('loadingState').style.display = 'none';

                if (!data.success) {
                    alert('Error: ' + data.error);
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                if (data.series.length === 0) {
                    document.getElementById('noResultsState').style.display = 'block';
                    return;
                }

                // Store results and populate table
                allResults = data.series;
                renderTable(allResults);

                document.getElementById('resultsCard').style.display = 'block';
                document.getElementById('filterCard').style.display = 'block';
                document.getElementById('resultCount').textContent = `Found ${data.count} series`;

            } catch (e) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                alert('Error: ' + e.message);
            }
        };

        // Render table rows
        function renderTable(results) {
            const tbody = document.getElementById('seriesTableBody');
            tbody.innerHTML = '';

            results.forEach(series => {
                const row = document.createElement('tr');
                row.dataset.name = (series.name || '').toLowerCase();
                row.dataset.volume = series.volume || '';
                row.dataset.year = series.year_began || '';
                row.dataset.issues = series.issue_count || 0;

                const slug = generateSeriesSlug(series.name, series.id, series.volume);
                row.innerHTML = `
                <td class="ps-4">
                    <a href="/series/${slug}" class="text-decoration-none fw-bold">
                        ${escapeHtml(series.name)}
                    </a>
                    ${series.volume ? `<span class="text-muted fw-normal ms-1">Vol. ${series.volume}</span>` : ''}
                </td>
                <td class="text-center">
                    ${series.issue_count
                        ? `<span class="badge bg-info">${series.issue_count}</span>`
                        : '<span class="text-muted">-</span>'}
                </td>
                <td>${series.year_began || '<span class="text-muted">-</span>'}</td>
                <td>${series.volume || '<span class="text-muted">-</span>'}</td>
            `;
                tbody.appendChild(row);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Generate series slug matching the Python generate_series_slug function
        function generateSeriesSlug(seriesName, seriesId, volume) {
            if (!seriesId) return null;
            if (!seriesName) return String(seriesId);

            // Convert to lowercase and replace non-alphanumeric chars with hyphens
            let slug = String(seriesName).toLowerCase();
            slug = slug.replace(/[^a-z0-9]+/g, '-');
            slug = slug.replace(/^-+|-+$/g, ''); // Trim leading/trailing hyphens

            // Add volume if provided
            if (volume) {
                slug = `${slug}-v${volume}`;
            }

            // Always append series_id for reliable lookup
            slug = `${slug}-${seriesId}`;

            return slug;
        }

        // Filter functionality
        function applyFilters() {
            const textFilter = document.getElementById('filterInput').value.toLowerCase().trim();

            const rows = document.querySelectorAll('#seriesTableBody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.dataset.name || '';

                const matchesText = !textFilter || name.includes(textFilter);

                if (matchesText) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            document.getElementById('resultCount').textContent = `Showing ${visibleCount} of ${allResults.length} series`;
        }

        document.getElementById('filterInput')?.addEventListener('input', applyFilters);

        // Sorting functionality
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function () {
                const sortKey = this.dataset.sort;

                if (currentSort.column === sortKey) {
                    currentSort.ascending = !currentSort.ascending;
                } else {
                    currentSort.column = sortKey;
                    currentSort.ascending = true;
                }

                // Update header icons
                document.querySelectorAll('.sortable i').forEach(icon => {
                    icon.className = 'bi bi-chevron-expand text-muted ms-1';
                });
                const icon = this.querySelector('i');
                icon.className = currentSort.ascending
                    ? 'bi bi-chevron-up text-primary ms-1'
                    : 'bi bi-chevron-down text-primary ms-1';

                // Sort the stored results
                const sorted = [...allResults].sort((a, b) => {
                    let aVal, bVal;

                    switch (sortKey) {
                        case 'name':
                            aVal = (a.name || '').toLowerCase();
                            bVal = (b.name || '').toLowerCase();
                            break;
                        case 'volume':
                            aVal = parseInt(a.volume) || 0;
                            bVal = parseInt(b.volume) || 0;
                            return currentSort.ascending ? aVal - bVal : bVal - aVal;
                        case 'year':
                            aVal = parseInt(a.year_began) || 0;
                            bVal = parseInt(b.year_began) || 0;
                            return currentSort.ascending ? aVal - bVal : bVal - aVal;
                        case 'issues':
                            aVal = parseInt(a.issue_count) || 0;
                            bVal = parseInt(b.issue_count) || 0;
                            return currentSort.ascending ? aVal - bVal : bVal - aVal;
                        default:
                            return 0;
                    }

                    const comparison = aVal.localeCompare(bVal);
                    return currentSort.ascending ? comparison : -comparison;
                });

                renderTable(sorted);
                applyFilters(); // Re-apply any active filters
            });
        });
    });
</script>
{% endblock %}